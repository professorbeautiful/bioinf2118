---
title: "Simple Bayes decision plots"
output: html_document
runtime: shiny
---

 
### Using Bayes expected loss to support a medical decision. 

### Actions to choose from:

* $T$: Treat
* $W$: Wait ("Watchful Waiting")

### Bayes expected loss for action $A$ = $\rho$ = $\rho (A|X) = {E_{\theta |X}}(Loss(\theta, A))$.

* $\rho (T|X) = Loss(Healthy, Treat) \times Pr(Healthy | X)$

* $\rho (W|X) = Loss(Sick, Wait) \times Pr(Sick | X)$


### Best decisions  (Bayes rule):

* Where the $W$ line is below the $T$ line, the better decision is $W$.
* Where the $T$ line is below the $W$ line, the better decision is $T$.
* Where (if) the $W$ and $T$ lines cross, the two decisions are equivalent, because they have the same Bayes expected loss.




```{r, echo=FALSE}
source("simplebayesdecision.R")
```



```{r, echo=FALSE}
#border-left:3px dashed;
dashWrap = function(s)
             HTML(paste0(
                  "<div style = 'color: rgba(0, 100, 200, 1); font-weight:strong';
                  font-style: italic;> âˆŽ", s,
                  "</div>") )
DashedLine = "
            border-color:  rgba(0, 100, 200, 1);
color: rgba(0, 100, 200, 1); 
font-weight: bold; 
background-color: rgba(200, 100, 0, 1)
"

longparamnames = c(prev="prevalence", 
                   sens="sensitivity",
                   spec="specificity",
               L.SW="Loss_given_S_and_W",
               L.HT="Loss_given_H_and_T")
paramArgDefaults = unlist(formals(plot.simple.bayes)[1:5])
###  a few alterations...
paramArgDefaults['prev'] = 0.1
paramArgDefaults['sens'] = 0.95
paramArgDefaults['spec'] = 0.95

paramArgNames = names(paramArgDefaults)
paramPlotRange = 
  paramPlotRangeDefaults = c(
                        prev='1/10^seq(0.5,4,0.1)',
                        sens='seq(0.5,1,.05)',
                        spec='seq(0.9,1,.01)',
                        L.SW='seq(0.5,10,0.5)',
                        L.HT='seq(0.5,10,0.5)')

observeEvent(
  input$parameterInputID,
  {
    which.varies = names(longparamnames)[
      which(input$parameterInputID ==
              longparamnames)]
    for(param in paramArgNames) 
      updateNumericInput(inputId=
        paste0(param, 'Default'),
        label= ifelse(
          param == which.varies,
          dashWrap(longparamnames[param]),
          longparamnames[param]) )
  })
output$parameterUI = renderUI(
  {
    wellPanel(
  fluidRow(
    splitLayout(
      
           numericInput(
                   'prevDefault',
                    ('prevalence') ,
                   value = paramArgDefaults['prev'],
                   min = 0, max=1, step = 0.01),
      numericInput('sensDefault',
                   ('sensitivity'),
                   value = paramArgDefaults['sens'],
                   min = 0, max=1, step = 0.01),
      numericInput('specDefault',
                   ('specificity'),
                   value = paramArgDefaults['spec'],
                   min = 0, max=1, step = 0.01)
    )),
  fluidRow(splitLayout(
    numericInput('L.SWDefault',
                 ('Loss<br>Sick&Wait'),
                 value = paramArgDefaults['L.SW'],
                 min = 0, max=10, step = 0.1),
    numericInput('L.HTDefault',
                 ('Loss<br>Healthy&Treat'),
                 value = paramArgDefaults['L.HT'],
                 min = 0, max=10, step = 0.1)
    ,
    selectInput(
      "dataInputID",
      label=HTML("Observation<br> (X)"),
      choices = c("Positive","Negative"),
      selected="Positive",
      selectize=FALSE)
  )),
  fluidRow(
    column(2, ""),
    column(8, 
           
    selectInput("parameterInputID", 
                label = dashWrap('horizontal axis'),
                choices = as.vector(longparamnames), 
                selected = as.vector(longparamnames[1]),
                selectize=FALSE)
    ),
    column(2, "")
    )
  )
  }
)

controls = list(
  h3(style='text-align:center', "Scenario"),
    uiOutput('parameterUI')
  
)

#### predictiveValueDisplay ####
predictiveValueDisplay = list(
  h3(style='text-align:center', 'Predictive values'),
  wellPanel(fluidRow(
    column(6, span(strong(
      "Pr(Sick given Positive)",
      em(textOutput('predValuePos'))))
    ),
    column(6, span(strong(
      "Pr(Healthy given Negative)",
      em(textOutput('predValueNeg'))))
))))
#### odds_display ####
odds_display = list(
  h3(style='text-align:center', 'Odds'),
  wellPanel(fluidRow(
    column(
      4, 
      span(strong(
        HTML("Prior odds"),
             em(textOutput('priorOdds')))) ),
    column(
      8,
      span(strong(#"Posterior odds  ", 
                  textOutput(
                    'observation'),
                  em(textOutput('postOdds'))))
    )
  )))

#### Odds_and_predictive_values ####
Odds_and_predictive_values = list(
  fluidRow(
    column(
      6,
      (odds_display)
    ),
    column(
      6,
      (predictiveValueDisplay)
    )
  )
)
```

* "__Horizontal axis Parameter__":  the parameter along the horizontal axis.
The vertical blue line occurs at the chosen value. 

* "__Observation__":  Either $P$ for positive test, or $N$ for negative test. Bayes expected loss for the two actions $T$ and $W$ is conditional on the observation.

```{r echo=FALSE} 
output$observation = renderText(
  paste("Posterior odds ", "given ", input$dataInputID))

output$priorOdds = renderText(
  as.character(signif(
    digits=2,
    input$prevDefault /
      (1-input$prevDefault)
  ))
)
output$postOdds = renderText( {
  priorOdds = input$prevDefault /
    (1-input$prevDefault) 
  LR = switch(
    input$dataInputID,
    Positive = 
      input$sensDefault / 
      (1 - input$specDefault),
    Negative = 
      (1-input$sensDefault) /
      input$specDefault
  )
  postOdds = priorOdds * LR
  as.character(
    signif(digits=2, postOdds
  ))
  })
output$predValuePos = renderText({
  prev = input$prevDefault
  sens = input$sensDefault
  spec = input$specDefault
  signif(digits=3,
         prev * sens / (prev * sens + (1-prev)*(1-spec))
  )
})
output$predValueNeg = renderText({
  prev = input$prevDefault
  sens = input$sensDefault
  spec = input$specDefault
  signif(digits=3,
         (1-prev) * spec / ((1-prev) * spec + prev*(1-sens))
)
})
    
output$thePlot = renderPlot({
  ## First, set all parameters to their defaults.
  paramArgDefaults['prev'] = input$prevDefault
  paramArgDefaults['sens'] = input$sensDefault
  paramArgDefaults['spec'] = input$specDefault
  paramArgDefaults['L.SW'] = input$L.SWDefault
  paramArgDefaults['L.HT'] = input$L.HTDefault
  sapply(paramArgNames, function(param) 
    assign(param, paramArgDefaults[param], envir=.GlobalEnv))
  #### paramPlotRange ####
  paramPlotRange['prev'] = input$prevRange
  paramPlotRange['sens'] = input$sensRange
  paramPlotRange['spec'] = input$specRange
  paramPlotRange['L.SW'] = input$L.SWRange
  paramPlotRange['L.HT'] = input$L.HTRange
  # sapply(paramArgNames, function(param) 
  #   assign(param, paramPlotRange[param], envir=.GlobalEnv))
  assign('paramPlotRange', paramPlotRange, envir=.GlobalEnv)
  ### Here pos=1 is the same as env=.GlobalEnv -- try search().
  ### Now, swap in the vector for the selected parameter.
  which.varies = names(longparamnames)[
    which(input$parameterInputID ==
            longparamnames)]
  cat(which.varies, '- ',
      longparamnames[which.varies], "--  ",
       "\n")
  horiz.label = input$parameterInputID 
  horiz.value.list = sapply(
    names(paramPlotRange),
    function(the.rangeName)
      eval(parse(text=
                   paramPlotRange[
                     the.rangeName]))
  )
  horiz.values = horiz.value.list[[which.varies]]
  
  #Save the default value, and reassign the vector of values
  default.value = paramArgDefaults[which.varies]
  # You need to use "assign"; we can't hard-code the variable name.
  cat ('paramArgNames \n')
  print(paramArgNames)
cat('longparamnames', '\n')
print(longparamnames)

         assign(which.varies,
         horiz.values)
  # cat(horiz.label, 'default VALUE=',
  #     default.value, '\nvalues\n', 
  #     horiz.values, "\n")
  #  assign(input$parameterInputID, horiz.values)
  E.loss = simple.bayes.vectorized(
    prev, sens, spec, L.SW, L.HT, 
    substr(input$dataInputID, 1, 1) )
  #cat('E.loss', '\n')
  #print(E.loss)
  E.loss.W = E.loss[ , 1]
  E.loss.T = E.loss[ , 2]
  #https://stackoverflow.com/questions/3778084/how-to-adjust-the-size-of-y-axis-labels-only-in-r
  plot(cex.axis=2, cex.lab=1.8,
    c(horiz.values, horiz.values), 
    c(E.loss.T, E.loss.W), 
    pch=" ",
    ylab="Bayes expected loss",
    xlab=input$parameterInputID,
    main=paste(
      "X = ", input$dataInputID,
      "   Varying ", input$parameterInputID))
  Wbetter = (E.loss.W < E.loss.T - 1e-2) 
  Tbetter = (E.loss.W > E.loss.T + 1e-2) 
  WbetterPlusOne = 1 + (E.loss.W < E.loss.T) 
  TbetterPlusOne = 1 + (E.loss.W > E.loss.T) 
  colorW = c('red', 'darkgreen')[WbetterPlusOne]
  colorT = c('red', 'darkgreen')[TbetterPlusOne]
  colorT[!(Wbetter | Tbetter)] = 
    colorW[!(Wbetter | Tbetter)] = 'blue'
  cexT = c(1,4)[TbetterPlusOne]
  cexW = c(1,4)[WbetterPlusOne]
  cexT[!(Wbetter | Tbetter)] = 
    cexW[!(Wbetter | Tbetter)] = 0
  # lines (horiz.values, E.loss.W, col=colorWbetter, lwd=3)
  # lines (horiz.values, E.loss.T, col=colorTbetter, lwd=3)
  points(horiz.values, E.loss.W, pch= "W",
         col=colorW, cex=cexW)
  points(horiz.values, E.loss.T, pch= "T",
         col=colorT, cex=cexT)
  abline(v=default.value, lty=3, lwd=10, col="blue")

  })

```

```{r, echo=F}
plotAxisControls = list(
  fluidRow(
    splitLayout(
      textInput('prevRange',
                   'prevalence axis',
                   value = paramPlotRange['prev']),
      textInput('sensRange',
                   'sensitivity axis',
                   value = paramPlotRange['sens']),
      textInput('specRange',
                   'specificity axis',
                   value = paramPlotRange['spec']),
      textInput('L.SWRange',
                   'Loss S&Waxis',
                   value = paramPlotRange['L.SW']),
      textInput('L.HTRange',
                   'Loss H&Taxis',
                   value = paramPlotRange['L.HT'])
)))

fluidPage(
  

  fluidRow(
    column(6, 
           h3(style='text-align:center; color:green', HTML(
                   'Best action is in GREEN')),
              plotOutput('thePlot')),
    column(5, (controls), offset=1)
  ),
  (Odds_and_predictive_values),
  h3("Axis controls"),
  wellPanel(plotAxisControls)  
)


```


