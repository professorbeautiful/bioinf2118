---
title: "Conditional dependence in medical diagnosis"
output: html_document
runtime: shiny
---

<!-- 
To Deploy: 
Click Run document, then in upper right: "Republish"
Or, 
rsconnect::deployApp(appFiles = 
c('simplebayesdecision-fancy.Rmd', 'inclRmd.R',
'conditionalPanelWithCheckbox.R','addOpacity.R',
'simplebayesdecision-info.Rmd', "simplebayesdecision.R" 
, "gerdPlot.R" 
, "gerdPlot2.R"  )) 
-->

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

```{r, echo=F}
usingShinyApp = FALSE
temp = suppressPackageStartupMessages(require('shinyjs', quietly=TRUE))
temp = suppressPackageStartupMessages(require('markdown', quietly=TRUE))

source("inclRmd.R")
source("conditionalPanelWithCheckbox.R")
source("addOpacity.R")
source("makePosteriorSequence.R")


```

```{r}
priorDefaults = 
  c(prior_dD=0.009, prior_hD=0.001, prior_iD=0.09, prior_noD=0.9)
prob_pos_Defaults = 
  c(prob_pos_dD=0.009, prob_pos_hD=0.001, prob_pos_iD=0.09, prob_pos_noD=0.9)

rV= reactiveValues(
  priors = priorDefaults
)  


output$priorUI = renderUI(
  {
    div(
      h3(style='text-align:center', "Initial (prior) probabilities"),
      fluidRow(
        splitLayout(
          numericInput(
            'prior_dD',
            ('detectable D') ,
            value = priorDefaults['prior_dD'],
            min = 0, max=1, step = 0.01),
          numericInput('prior_hD',
                       ('hidden D'),
                       value = priorDefaults['prior_hD'],
                       min = 0, max=1, step = 0.01),
          numericInput('prior_iD',
                       ('imposter D'),
                       value = priorDefaults['prior_iD'],
                       min = 0, max=1, step = 0.01),
          numericInput('prior_noD',  
              ### best to slave this one for now.
                       ('no D'),
                       value = priorDefaults['prior_noD'],
                       min = 0, max=1, step = 0.01)
        )))
    
  }
)
output$whichFollows = renderUI(
  radioButtons(inputId = 'whichFollows', 
               choices = c('dD', 'hD', 'iD', 'noD'), label='which is dependent',
   selected='noD', width='400px',
  inline=T))


output$prob_pos_UI = renderUI(
  {
    div(
      h3(style='text-align:center', "Initial (prior) probabilities"),
      fluidRow(
        splitLayout(
          numericInput(
            'prob_pos_dD',
            ('detectable D') ,
            value = prob_pos_Defaults['prob_pos_dD'],
            min = 0, max=1, step = 0.01),
          numericInput('prob_pos_hD',
                       ('hidden D'),
                       value = prob_pos_Defaults['prob_pos_hD'],
                       min = 0, max=1, step = 0.01),
          numericInput('prob_pos_iD',
                       ('imposter D'),
                       value = prob_pos_Defaults['prob_pos_iD'],
                       min = 0, max=1, step = 0.01),
          numericInput('prob_pos_noD',  
              ### best to slave this one for now.
                       ('no D'),
                       value = prob_pos_Defaults['prob_pos_noD'],
                       min = 0, max=1, step = 0.01)
        )))
    
  }
)
output$ObservationUI = 
  renderUI(
    div(
        textInput(
          "dataInputID",
          value = "1 1 1 1",
          label=HTML("Test results (1s and 2s, format like 1 2 1 2)"),
        ))
  )
```

```{r}

ui = 
  fillPage(  #fillPage and fluidPage the same.
    useShinyjs(rmd=TRUE, debug=TRUE),  ## this is the place!!
    fluidRow(
      column(12,   uiOutput('priorUI')), 
      column(12,   uiOutput('whichFollows')),
      column(12,   uiOutput('ObservationUI')), 
      #https://stackoverflow.com/questions/51460955/how-to-make-kable-table-reactive-in-shiny-app-shiny-kable
      column(12,   htmlOutput('makePosteriorSequence')),
      column(12,   'all done!')
    )
  )

```

```{r}
####  server ####

server = function(input, output) {
  observeEvent( 
    c(input$prior_dD, input$prior_dD, input$prior_iD, input$prior_noD ),
    {
  #radio
      switch(input$whichFollows,
             hD= updateNumericInput(
               inputId='prior_hD', value = 1 - 
                 input$prior_dD-input$prior_iD-input$prior_noD),
             dD=updateNumericInput(
               inputId='prior_dD', value = 1 - 
                 input$prior_hD - input$prior_iD - input$prior_noD),
             iD=updateNumericInput(
               inputId='prior_iD', value = 1 - 
                 input$prior_dD - input$prior_hD - input$prior_noD),
             noD=updateNumericInput(
               inputId='prior_noD', value = 1 - 
                 input$prior_dD - input$prior_iD - input$prior_hD)
      )
    }
  )
#         {
#           rV$priors =
#           c(prior_dD=input$prior_dD, prior_hD=input$prior_hD,
#             prior_iD=input$prior_iD, prior_noD=input$prior_noD)
# })

  #rV = reactiveValues(prior=c())
  # posteriorSequenceOutput =
  #   reactiveVal('posteriorSequenceOutput')
  
  run_makePosteriorSequence = function() {
    # TODO, maybe
  }
  output$makePosteriorSequence = renderText({
    req(input$dataInputID)
    req(c(input$prior_dD, input$prior_hD, input$prior_iD, input$prior_noD))
    this_priorFor4 = 
      c(input$prior_dD, input$prior_hD, input$prior_iD, input$prior_noD)
    this_prob_pos_given_group = c(input$prob_pos_dD,input$prob_pos_hD, input$prob_pos_iD,input$prob_pos_noD)
    dataSequence = strsplit(split=' ',
                            input$dataInputID)[[1]]
    dataSequence = sapply(dataSequence, as.numeric)
    print(dataSequence)
    ## only 1's and 2's
    #dataSequence <<- rep(1,4)
    if(all(dataSequence %in% 1:2)) { #proceed
      #run_makePosteriorSequence()
      #posteriorSequenceOutput ( 
      (
        makePosteriorSequence(
          priorFor4 = rV$priors,
          prob_pos_given_group = this_prob_pos_given_group,
          dataSequence = dataSequence, ### 1's and 2's
          wordsForData = c("'Pos'\\quad", "'Neg'\\quad"),
          dropZeroGroups = FALSE,
          makeHTML = TRUE, 
          marginalize = FALSE # input$marginalize
        ) ) 
    } ### end, call to makePosteriorSequence
  })  ### end, renderText 
}  ## end, server


if(usingShinyApp) {
  shinyApp(ui = ui, server = server)
} else {
  server(input, output)
  ui
}


```

